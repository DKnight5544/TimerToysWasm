@page "/"
@page "/{id}"

@using TimerToysShared.Model
@using System.Collections.Generic
@inject HttpClient Http
@inject NavigationManager NavManager


@{

    <PageComponent @ref="pageComp"></PageComponent>

    for (int idx = 0; idx < 50; idx++)
    {
        int i2 = idx;
        <TimerToyComponent @ref=tta[i2] />
    }

    if (timers == null)
    {
        <h4><em>Still Loading . . .</em></h4>
    }
    else
    {
        if (string.IsNullOrWhiteSpace(id))
        {
            NavManager.NavigateTo(string.Format("/{0}", timers[0].PageKey));
        }

        int idx = 0;
        foreach (Timer t in timers.OrderBy(t => t.SortIndex))
        {
            tta[idx].SetTimer(t);
            idx++;
        }

        pageComp.SetTimerArray(tta);

        ticker = new System.Threading.Timer(Tick, null, 1000, 1000);

    }

}


@code {

    [Parameter]
    public string id { get; set; }

    private Timer[] timers;

    private System.Threading.Timer ticker;


    private PageComponent pageComp = new PageComponent();
    private TimerToyComponent[] tta = new TimerToyComponent[50];

    protected override async Task OnInitializedAsync()
    {

        if (string.IsNullOrWhiteSpace(id))
        {
            timers = await Http.GetFromJsonAsync<Timer[]>("GetNewPage");
        }
        else
        {
            timers = await Http.GetFromJsonAsync<Timer[]>(string.Format("GetAllByPage/{0}", id));
        }

    }

    private void Tick(Object stateInfo)
    {
        foreach (TimerToyComponent t in tta)
        {
            if(t.IsTimerSet) t.Tick();
        }
    }
}
